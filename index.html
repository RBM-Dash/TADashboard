<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TA Dashboard | 2021</title>
    <style type="text/css">
        .dropdown-menu {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="../plugins/fontawesome-free/css/all.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="/css/myadminlteTA.min.css">
</head>

<body>
    <div class="container-fluid">
        <!-- Navbar -->
        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <!-- =========================================================== -->
                <!-- <h5 class="mt-4 mb-2">Technical Assistance (2021)</h5> -->
                <div class="row">
                    <div class=" col-md-2 col-sm-6 col-12">
                        <div class="info-box  bg-info" data-toggle="tooltip" data-placement="bottom"
                            title="TA Needs is the total number of TAs for all countries supported in current year">
                            <span class="info-box-icon"><i class="far fa-calendar-check"></i></span>

                            <div class="info-box-content">
                                <span class="info-box-text">TA Needs</span>
                                <span class="info-box-number" id="TAPlanned"></span>

                                <div class="progress">
                                    <div class="progress-bar" id="PercentTAPlanned" style="width: 100%"></div>
                                </div>
                                <span class="progress-description text-xs" id="textPercentTAPlanned"><em><small>
                                            Hover for definitions</small></em>
                                </span>
                            </div>


                            <!-- /.info-box-content -->
                        </div>
                        <!-- /.info-box -->
                    </div>
                    <div class=" col-md-2 col-sm-6 col-12">
                        <div class="info-box  bg-primary" data-toggle="tooltip" data-placement="bottom"
                            title="A TA (requested or not) is considered as due when it's starting date has passed. A due TA is managed if it is Ongoing, Postponed or Completed ">

                            <span class="info-box-icon"><i class="far fa-bookmark"></i></span>

                            <div class="info-box-content">
                                <span class="info-box-text">TA Due</span>
                                <span class="info-box-number" id="TARequested"></span>

                                <div class="progress">
                                    <div class="progress-bar" id="PercentTARequested" style="width: 70%"></div>
                                </div>
                                <span class="progress-description text-xs" id="textPercentTARequested">

                                </span>
                            </div>


                            <!-- /.info-box-content -->
                        </div>
                        <!-- /.info-box -->
                    </div>
                    <!-- /.col -->
                    <div class=" col-md-2 col-sm-6 col-12">
                        <div class="info-box bg-success" data-toggle="tooltip" data-placement="bottom"
                            title="The percentage of completed TAs is referred to the managed TAs">
                            <span class="info-box-icon"><i class="far fa-thumbs-up"></i></span>

                            <div class="info-box-content">
                                <span class="info-box-text">TA Completed</span>
                                <span class="info-box-number" id="TACompleted"></span>

                                <div class="progress">
                                    <div class="progress-bar" id="PercentTACompleted" style="width: 70%">
                                    </div>
                                </div>
                                <span class="progress-description text-xs" id="textPercentTACompleted">

                                </span>
                            </div>
                            <!-- /.info-box-content -->
                        </div>
                        <!-- /.info-box -->
                    </div>
                    <!-- /.col -->
                    <div class="col-md-2 col-sm-6 col-12">
                        <div class="info-box bg-warning" data-toggle="tooltip" data-placement="bottom"
                            title="The percentage of ongoing TAs is referred to the due TAs. It includes requested TAs where TORs are under processing">

                            <span class="info-box-icon"><i class="fa fa-spinner" style="color:white"></i></span>

                            <div class="info-box-content">
                                <span class="info-box-text">TA Ongoing</span>
                                <span class="info-box-number" id="TAOngoing"></span>

                                <div class="progress">
                                    <div class="progress-bar" id="PercentTAOngoing" style="width: 70%"></div>
                                </div>
                                <span class="progress-description text-xs" id="textPercentTAOngoing">

                                </span>
                            </div>
                            <!-- /.info-box-content -->
                        </div>
                        <!-- /.info-box -->
                    </div>
                    <!-- /.col -->
                    <div class="col-md-2 col-sm-6 col-12">
                        <div class="info-box bg-danger" data-toggle="tooltip" data-placement="bottom"
                            title="The percentage of postponed TAs is referred to the due TAs">
                            <span class="info-box-icon"><i class="fa fa-business-time" style="color:white"></i></span>
                            <!-- <span class="info-box-icon"><i class="ion-ios-alarm"></i></span>-->

                            <div class="info-box-content">
                                <span class="info-box-text">TA Postponed</span>
                                <span class="info-box-number" id="TAPostponed"></span>

                                <div class="progress">
                                    <div class="progress-bar" id="PercentTAPostponed" style="width: 70%">
                                    </div>
                                </div>
                                <span class="progress-description text-xs" id="textPercentTAPostponed">

                                </span>
                            </div>
                            <!-- /.info-box-content -->
                        </div>
                        <!-- /.info-box -->
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->

                <div class="row">
                    <div class="col-md-12">

                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">TECHNICAL ASSISTANCE (TA) PLAN FOR 2021</h5>
                                </h5>
                                <p style="text-align: right"><small><em> Hover on bars indicating task duration to
                                            see their full description</em></small></p>

                                <div class="card-tools">
                                    <div class="btn-group">
                                        <button type="button" id="slist"
                                            class="btn btn-default dropdown-toggle bg-primary text-xs"
                                            data-toggle="dropdown">
                                            Select Status
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right has-mega-menu" role="menu"
                                            id="sselect">
                                            <a href="#" class="dropdown-item text-xs">All</a>
                                            <a href="#" class="dropdown-item text-xs">Completed</a>
                                            <a href="#" class="dropdown-item text-xs">Ongoing</a>
                                            <a href="#" class="dropdown-item text-xs">Postponed</a>
                                            <a href="#" class="dropdown-item text-xs">Pending/Unknown</a>
                                            <a href="#" class="dropdown-item text-xs">Not Requested</a>

                                        </div>
                                    </div>

                                    <div class="btn-group">
                                        <button type="button" id="clist"
                                            class="btn btn-default dropdown-toggle bg-primary text-xs"
                                            data-toggle="dropdown">
                                            Select Country
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right has-mega-menu" role="menu"
                                            id="cselect">
                                            <a href="#" class="dropdown-item text-xs">All</a>

                                        </div>
                                    </div>

                                </div>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">

                                        <div class="chart gantt" id="GanttChartDIV">

                                            <!-- /.chart-responsive -->
                                        </div>
                                        <!-- /.col -->

                                        <!-- ./card-body -->
                                        <div class="card-footer"></div>
                                    </div>
                                    <!-- /.row -->
                                </div>
                                <!-- /.card-footer -->
                            </div>
                            <!-- /.card -->
                        </div>
                        <!-- /.col -->
                    </div>
                </div>
                <!-- /.row -->
            </div><!-- /.container-fluid -->
        </section>
        <!-- /.content -->

        <a id="back-to-top" href="#" class="btn btn-primary back-to-top" role="button" aria-label="Scroll to top">
            <i class="fas fa-chevron-up"></i>
        </a>
        <!-- /.content-wrapper -->
    </div>
    <!-- ./wrapper -->

    <!-- jQuery -->
    <script src="../plugins/jquery/jquery.min.js"></script>
    <!-- jQuery UI 1.11.4 -->
    <!-- Bootstrap 4 -->
    <script src="../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="../js/adminlte.min.js" type="text/javascript" x-content-type-options="nosniff"></script>
    <script src="/js/papaparse.min.js" type="text/javascript" x-content-type-options="nosniff"></script>
    <script src="/js/lodash.min.js" type="text/javascript" x-content-type-options="nosniff"></script>
    <link href="/css/jsgantt.css" rel="stylesheet" type="text/css" />
    <script src="/js/jsgantt.js" type="text/javascript" x-content-type-options="nosniff"></script>

</body>
<script>
    $(document).ready(function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    })

    var g = new JSGantt.GanttChart(document.getElementById('GanttChartDIV'), 'quarter');
    function onlyUnique(value, index, self) { return self.indexOf(value) === index; }
    function isValidDate(d) { return d instanceof Date && !isNaN(d); }
    function fillGantt(result, myCountry, thisOpened) {
        let cont = 0;
        let isOpen = 1;
        g.ClearTasks();
        g.Draw();
        for (let i = 0; i < myCountry.length; i++) {
            temp = _.filter(result, ['cname', myCountry[i]]);
            let myD = []; let myldata = []; let myT = [];
            if (i > thisOpened) { isOpen = 0 };
            //Define a group for the country
            let myPParent = cont;
            var dates = temp.map(function (x) { return new Date(x.startDate); });
            var earliest = new Date(Math.min.apply(null, dates));
            var latest = new Date(Math.max.apply(null, temp.map(function (x) { return new Date(x.endDate); })));
            cont = cont + 1;
            for (let j = 0; j < temp.length; j++) {
                // Start filling the Gantt
                if (j == 0) {
                    g.AddTaskItemObject({
                        pID: myPParent,
                        pName: myCountry[i],
                        pStart: earliest,
                        pEnd: latest,
                        pPlanStart: "",
                        pPlanEnd: "",
                        //pClass: "gtaskblue",
                        pClass: "ggroupblack",
                        pLink: "",
                        pMile: 0,
                        pRes: "",
                        pComp: 0,
                        pGroup: 1,
                        pParent: 0,
                        pOpen: isOpen,
                        pDepend: "",
                        pCaption: "",
                        pCost: 0,
                        pNotes: "",
                        pBarText: "",
                        category: "",
                        sector: ""
                    });
                };
                //Fill in the Gantt structure
                //Define the class of the bar and the completation according to status
                let myNStatus = ""; var tt;
                switch (temp[j].Status) {
                    case "Completed":
                        myClass = "gtaskgreen";
                        myComp = 100;
                        break;
                    case "Ongoing":
                        myClass = "gtaskyellow";
                        tt = (100 * (Math.abs(new Date() - temp[j].startDate) / Math.abs(temp[j].endDate - temp[j].startDate))).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                        myComp = (tt > 100) ? 90 : tt;
                        break;
                    case "Undefined":
                        myClass = "gtaskpurple";
                        myNStatus = (temp[j].due) ? "Pending" : "Not yet due";
                        myComp = 0;
                        break;
                    case "Requested":
                        myClass = "gtaskyellow";
                        myNStatus = "Request under processing";
                        myComp = 5;
                        break;
                    case "Postponed":
                        myClass = "gtaskred";
                        myComp = 0;
                        break;
                    default:
                        myClass = "gtaskpurple";
                        myComp = 0;
                }
                g.AddTaskItemObject({
                    pID: cont,
                    pName: temp[j].Activity,
                    pStart: temp[j].startDate,
                    pEnd: temp[j].endDate,
                    pPlanStart: temp[j].startDate,
                    pPlanEnd: temp[j].endDate,
                    pClass: myClass,
                    pLink: "",
                    pMile: 0,
                    pRes: temp[j].Partner,
                    pComp: myComp,
                    pGroup: 0,
                    pParent: myPParent,
                    pOpen: isOpen,
                    pDepend: "",
                    pCaption: (myNStatus.length > 0) ? myNStatus : temp[j].Status,
                    pCost: 0,
                    pNotes: temp[j].Comments,
                    pBarText: "",
                    category: "",
                    sector: ""
                });
                cont = cont + 1;
            }
        }
        g.setUseFade(0);
        g.setUseMove(1);
        g.setUseSort(0);
        g.setShowDur(0);
        g.setShowComp(0);
        g.setShowEndDate(0);
        g.setShowTaskInfoDur(0);
        g.setShowTaskInfoComp(0);
        g.setShowTaskInfoEndDate(0);
        g.setShowSelector("Top");
        g.setDateTaskTableDisplayFormat('mon, yyyy');
        g.setAdditionalHeaders({ pCaption: { title: 'Status' } });
        g.setOptions({
            vCaptionType: 'Complete',  // Set to Show Caption : None,Caption,Resource,Duration,Complete,     
            vQuarterColWidth: 30,
            vDateTaskDisplayFormat: 'month yyyy', // Shown in tool tip box
            vShowTaskInfoLink: 0, // Show link in tool tip (0/1)
            vShowEndWeekDate: 0,  // Show/Hide the date for the last day of the week in header for daily view (1/0)
            vUseSingleCell: 0, // Set the threshold at which we will only use one cell per table row (0 disables).  Helps with rendering performance for large charts.
            vFormatArr: ['Month', 'Quarter'], // Even with setUseSingleCell using Hour format on such a large chart can cause issues in some browsers
        });
        return g;
    };
    Papa.parse("https://docs.google.com/spreadsheets/d/1KUQ4RLhfd9y4HSLiDdkFGS7cuLr9-YMXqzNHpVV4nf4/gviz/tq?tqx=out:csv&sheet=MyTA 2021", {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: 'greedy',
        complete: function (results) {
            //Erase records where cname is empty
            let result = _.reject(results.data, { 'cname': null });
            result = _.reject(result, { 'cname': "Country" });
            result = _.reject(result, ['Activity', null]);
            //console.log(result)
            //Correct Dates for all
            result = _.forEach(result, function (value) {
                var currentTime = new Date();
                var myDate = new Date(value.OSDate);
                if (myDate.getFullYear() === currentTime.getFullYear()) {
                    //Modify the date so that due date is the end of the month if not defined
                    var d = new Date(myDate.getFullYear(), myDate.getMonth() + 1, 0);
                    startDate = d;
                    endDate = new Date(myDate.getFullYear(), myDate.getMonth() + 2, 30);
                } else {
                    //Retrieve the Date from the quarter and year but only if there is not a full Date
                    if (!(_.isFinite(value.StartYear))) { value.StartYear = currentTime.getFullYear() };
                    if ((_.isFinite(value.StartYear))) {
                        endDate = new Date(currentTime.getFullYear(), (value.StartMonth + 1), 30);
                        startDate = new Date(currentTime.getFullYear(), (value.StartMonth - 1), 28);
                    } else {
                        endDate = new Date(currentTime.getFullYear(), (value.StartQuarter * 3), 30);
                        startDate = new Date(currentTime.getFullYear(), (value.StartQuarter * 3 - 2), 1);
                    }
                }
                value.startDate = startDate;
                value.endDate = endDate;
                value.due = ((currentTime - startDate) > 0);
                //console.log(value);
            });
            //Start filling the info boxes
            //These are all TAs in the Table. Appear under label "TA Needs"
            $("#TAPlanned").text(result.length);
            //Create the denominator for all analysis in the info-boxes. This is result with due = true 
            //First fill in all the Managed TAs considering only the due tasks. HERE
            var notRequested = (_.filter(result, ['Status', "Not Requested"]));

            var dueResult = (_.filter(result, ['due', true]));

            dueResult = _.reject(dueResult, ['Status', "Not Requested"]);
            console.log(dueResult);
            console.log(_.filter(dueResult, ['Status', "Completed"]).length);
            console.log(_.filter(dueResult, ['Status', "Ongoing"]).length)
            console.log(_.filter(dueResult, ['Status', "Postponed"]).length)
            console.log(_.filter(dueResult, ['Status', "Requested"]).length)
            $("#TARequested").text(dueResult.length + notRequested.length);
            //These are all TAs in the Table minus the Not requested ones. Appear under label "TA Managed. This is the Denominator for the rest"
            $("#TACompleted").text(_.filter(dueResult, ['Status', "Completed"]).length);
            $("#TAOngoing").text(_.filter(dueResult, ['Status', "Ongoing"]).length + _.filter(dueResult, ['Status', "Requested"]).length);
            $("#TAPostponed").text(_.filter(dueResult, ['Status', "Postponed"]).length);

            var myNum;
            var myNumC = _.filter(dueResult, ['Status', "Completed"]).length;
            myNum = 100 * (myNumC / (dueResult.length));
            //$("#PercentTACompleted").width(myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
            $("#PercentTACompleted").attr("style", "width:" + myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + "%");
            $("#textPercentTACompleted").text(myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + "% of managed TAs");

            var myNumO = (_.filter(dueResult, ['Status', "Ongoing"]).length + _.filter(dueResult, ['Status', "Requested"]).length);
            myNum = 100 * myNumO / (dueResult.length);
            $("#PercentTAOngoing").attr("style", "width:" + myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + "%");
            $("#textPercentTAOngoing").text(myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + "% of managed TAs");

            var myNumP = (_.filter(dueResult, ['Status', "Postponed"]).length);
            myNum = 100 * myNumP / (dueResult.length);
            $("#PercentTAPostponed").attr("style", "width:" + myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + "%");
            $("#textPercentTAPostponed").text(myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + "% of managed TAs");
            //By requested we mean the ones that have been or are under processing
            var myNume = _.filter(dueResult, ['Status', "Ongoing"]).length + _.filter(dueResult, ['Status', "Completed"]).length + _.filter(dueResult, ['Status', "Postponed"]).length;
            myNum = 100 * myNume / (dueResult.length + notRequested.length);
            //$("#PercentTARequested").width(myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
            $("#PercentTARequested").attr("style", "width:" + myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + "%");
            $("#textPercentTARequested").text(myNum.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + "% of due TAs managed ");


            //Populate dropdown list of countries
            var countries = _.map(result, 'cname').filter(onlyUnique);
            countries = countries.sort();
            const ocountries = _.map(result, 'cname').filter(onlyUnique);

            var lCountries = $("#cselect");

            $(countries).each(function () {
                var option = $("<a></a>");

                //Set country Name in Text part.
                option.html(this);

                //Set class and href.
                $(option).attr("class", "dropdown-item text-xs");
                $(option).attr("href", "#");

                //console.log(option)
                //Add the Option element to DropDownList.
                lCountries.append(option);
            });

            /*   var temp; let myData = []; let tmp; let startDate;
              let cont = 1; */
            var myCountry = countries;

            //Find a way to monitor the dropdown list and filter by country if requested

            $("#cselect a").on('click', function (e) {
                e.preventDefault(); // cancel the link behaviour
                var myCountry = [$(this).text()];
                if (myCountry[0] === "All") { myCountry = countries };

                g = fillGantt(result, myCountry, 10);

                g.Draw();
            });
            var g = fillGantt(result, myCountry, 10);
            g.Draw();
            //Find a way to monitor the status dropdown list and filter by status if requested
            var fresult;
            $("#sselect a").on('click', function (e) {
                e.preventDefault(); // cancel the link behaviour
                var myStatus = [$(this).text()];
                if (myStatus[0] === "All") {
                    fresult = result
                } else {

                    if (myStatus[0].startsWith("Pending")) { myStatus[0] = "Undefined" }
                    fresult = _.filter(result, ['Status', myStatus[0]])

                };

                g = fillGantt(fresult, myCountry, 300);

                g.Draw();
            });
            var g = fillGantt(result, myCountry, 10);
            g.Draw();



        },

    });



</script>
<script>$('[data-toggle="tooltip"]').tooltip();</script>

</html>